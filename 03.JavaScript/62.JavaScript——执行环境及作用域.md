##
执行环境(execution context,为简单起见，有时也称为"环境")是JavaScript中最重要的一个概念。
执行环境定义了变量或函数有权访问的其他数据，决定了它们各自的行为。每个执行环境都有一个与之关联的变量对象(variable object)，环境中定义的所有变量和函数都保持在这个对象中。
虽然我们编写的代码无法访问这个对象，但解析器会在处理数据时会在后台使用它。

全局执行环境是最外围的一个执行环境。根据ECMAScript实现所在的宿主环境不同，表示执行环境的对象也不一样。在Web浏览器中，全局执行环境被认为是window对象，因此，所以全局变量和函数都是作为window对象的属性和方法创建的。

某个执行环境中的所有代码执行完毕后，该环境被销毁，保存在其中的所有变量和函数定义也随之销毁(全局执行环境直到应用程序退出——例如关闭网页或浏览器时才会被销毁)。

每个函数都有自己的执行环境。当执行流进入一个函数是，函数的环境就会被推入一个环境栈中。而在函数执行之后，栈将其环境弹出，把控制权返回给之前的执行环境。ECMAScript程序中的执行流正式由这个方便的机制控制着。

当代码在一个环境中执行时，会创建变量对象的一个作用域链(scope chain)。
作用域链的用途，是保证对执行环境有权访问的所有变量和函数的有序访问。作用域链的前端，始终都是当前执行的代码所在环境的变量对象。如果这环境是函数，则将其活动对象(activation object)作为变量对象。

活动对象在最开始时只包含一个变量，即arguments对象(这个对象在全局环境中是不存在的)。作用域链中的下一个变量对象来自包含(外部)环境，而再下一个变量对象则来自下一个包含环境。这样，一直延续到全局执行环境；全局执行环境的变量对象始终都是作用域链中的最后一个对象。

标识符解析是沿着作用域链一级一级的搜索标识符的过程。搜索过程始终从作用域链的前端开始，然后逐级的向后回溯，直到找到标识符为止(如果找不到标识符，通常会导致错误发生)。
代码如下：
    var color = "blue";

    function changeColor(){
        if(color === "blue"){
            color = "red";
        }else{
            color = "blue";
        }
    }

    changeColor();
    alert("Color is now " + color);

在这个简单的例子中，函数changeColor()的作用域链包含两个对象:它自己的变量对象(其中定义着arguments对象)和全局环境的变量对象。可以在函数内部访问变量color，就是因为可以在这个作用域链中找到它。

此外，在局部作用域中定义的变量可以在局部环境中与全局 变量互换使用，示例如下：

    var color = "blue";

    function changeColor(){
        var anotherColor = "red";

        function swapColor(){
            var tempColor = anotherColor;
            anotherColor = color;
            color = tempColor;

            //这里可以访问color、anotherColor和tempColor
        }

        //这里可以访问color和anotherColor，但不能访问tempColor

        swapColor();
    }

    //这里只能访问color
    changeColor();

以上代码共涉及3个执行环境:全局环境、changeColor()的局部环境和swapColor()的局部环境。

全局环境中有一个变量color和一个函数changeColor()。changeColor()的局部环境中有一个名为anotherColor的变量和一个名为swapColor()的函数，但它也可以访问全局环境中的变量color。swapColor()的局部环境中有一个变量tempColor，该变量只能在这个环境中访问到。

无论全局环境还是changeColor()的局部环境都无权访问tempColor。然而，在swapColor()内部则可以访问其他两个环境中的所有变量，因为那两个环境是它的父执行环境。
如下图所示：

    window
      |
      |_____color
      |
      |_____changeColor()
                 |
                 |_____anotherColor
                 |
                 |_____swapColor()
                           |
                           |_____tempColor

    图中，内部环境可以通过作用域链访问所有的外部环境，但外部环境不能访问内部环境中的任何变量和函数。
    这些环境之间的联系是线性、有次序的。每个环境都可以向上搜索作用域链，以查询变量和函数名；但任何环境都不能通过向下搜索作用域链而进入另一个执行环境。

    对于这个例子中的swapColor()而言，其作用域链中包含3个对象:swapColor()的变量对象、changeColor()的变量对象和全局变量对象。swapColor()的局部环境开始时会先在自己的变量对象中搜索变量和函数名，如果搜索不到则再搜索上一级作用域链。changeColor()的作用域链中只包含连个对象:它自己的变量和全局变量对象。也就是说，它不能访问swapColor()的环境。

    注意：
        函数参数也被当作变量来对待，因此其访问规则与执行环境中的其他变量相同。

一、延长作用域链
    虽然执行环境的类型总共只有两种：全局和局部(函数)，但还是有其他办法来延长作用域链。这么说是因为有些语句可以在作用域链的前端临时增加一个变量对象，该变量对象会在代码执行后被移除。在两种情况下会发生这种现象。

    具体来说，就是当执行流进入下列任何一个语句时，作用域链就会得到加长:
        1、try-catch语句的catch块；
        2、with语句；

    这连个语句都会在作用域链的前端添加一个变量对象。对with语句来说，会将指定的对象添加到作用域链中。
    对catch语句来说，会创建一个新的变量对象，其中包含的是被抛出的错误对象的声明。
    示例如下：

        function buildUrl(){
            var qs = "?debug=true";

            with(location){
                var url = href + qs;
            }

            return url;
        }

    在此，with语句接收的是location对象，因此其变量对象中就包含了location对象的所有属性和方法，而这个变量对象被添加到了作用域链的前端。buildUrl()函数中定义了一个变量qs。当在with语句中引用变量href时(实际引用的是location.href)，可以在当前执行环境的变量对象中找到。

    当引用变量qs时，引用的则是buildUrl()中定义的那个变量，而该变量位于函数环境的变量对象中。至于with语句内部，则定义了一个名为url的变量，因此url就成了函数执行环境的一部分，所以可以作为函数的值被返回。

二、没有块级作用域
    JavaScript没有块级作用域经常会导致理解上的困惑。在其他类C的语言中，由花括号封闭的代码块都有自己的作用域(如果用ECMAScript的话来讲，就是它们自己的执行环境)，因而支持根据条件来定义变量；。
    如下图所示：

    if(true){
        var color = "blue";
    }

    alert(color);               //"blue"

这里是在一个if语句中定义了变量color。如果是在C、C++或者Java中，color会在if语句执行完毕后被销毁。
但在JavaScript中，if语句中的变量声明会将变量添加到当前的执行环境(在这里是全局环境)中。在使用for语句时尤其要牢记这一差异，例如：
for(var i = 0; i < 10; i++){
    
}

alert(i);                   ///10

对于有块级作用域的语言来说，for语句初始化变量的表达式所定义的变量，只会存在于循环的环境之中。而对于JavaScript来说，由for语句创建的变量i即使在for循环执行结束后，也依旧会存在于外部的执行环境中。

总结：
    所以变量(包括基本类型和引用类型)都存在于一个执行环境(也称为作用域)当中，这个执行环境决定了变量的生命周期，以及哪一部分代码可以访问其中的变量。要注意如下几点：
    1、执行环境有全局执行环境(也称为全局环境)和函数执行环境之分；
    2、每次进入一个新的执行环境，都会创建一个用于搜索变量和函数的作用域链；
    3、函数的局部环境不仅有权访问函数作用域中的变量，而且有权访问其包含(父)环境，乃至全局环境；
    4、全局环境只能访问全局环境中定义的变量和函数，而不能直接访问局部环境中的任何数据；
    5、变量的执行环境有助于确定应该何时释放内存。
